<!doctype html>
<html lang="cs">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Rezervace Smyslokoutek – výběr termínu & platba</title>
  <meta name="theme-color" content="#ffffff" />
  <meta name="color-scheme" content="light only" />
  <style>
    :root{
      --ink:#0b0b0b; --muted:#6b7280; --ok:#16a34a; --bad:#dc2626; --brand:#0ea5e9;
      --card:#fff; --bg:#f6f7fb; --soft:#eef2ff; --radius:16px; --shadow:0 10px 30px rgba(0,0,0,.08)
    }
    html{box-sizing:border-box}*,*::before,*::after{box-sizing:inherit}
    input[type="text"],input[type="email"],input[type="tel"]{width:100%;max-width:100%;display:block;-webkit-appearance:none;appearance:none}
    html,body{margin:0;background:var(--bg);color:var(--ink);font-family:system-ui,-apple-system,Segoe UI,Inter,Roboto,Arial,sans-serif}
    .wrap{max-width:980px;margin:0 auto;padding:20px}
    .hero{background:var(--card);border-radius:var(--radius);box-shadow:var(--shadow);padding:20px;margin-bottom:16px}
    .hero h1{margin:0 0 6px;font-size:22px}.hero p{margin:0;color:var(--muted)}
    .grid{display:grid;grid-template-columns:2fr 1fr;gap:16px}
    @media (max-width:900px){.grid{grid-template-columns:1fr}}
    .panel{background:var(--card);border-radius:var(--radius);box-shadow:var(--shadow);padding:18px;overflow:hidden}
    .term-list{display:grid;grid-template-columns:1fr 1fr;gap:12px}
    @media (max-width:700px){.term-list{grid-template-columns:1fr}}
    .term{border:1px solid #e5e7eb;border-radius:14px;padding:14px;cursor:pointer;background:#fff;transition:.15s}
    .term:hover{border-color:#c7d2fe;background:var(--soft)}.term.active{outline:2px solid var(--brand);border-color:transparent;background:var(--soft)}
    .term h3{margin:0 0 8px;font-size:16px}.term .meta{font-size:13px;color:var(--muted)}
    .controls{display:flex;gap:12px;align-items:center;flex-wrap:wrap;margin:12px 0}
    .stepper{display:flex;align-items:center;border:1px solid #e5e7eb;border-radius:12px;overflow:hidden}
    .stepper button{border:0;background:#f3f4f6;width:40px;height:40px;font-size:20px;cursor:pointer}
    .stepper input{width:70px;height:40px;border:0;text-align:center;font-size:16px}
    label{font-weight:600}
    input[type="text"],input[type="email"],input[type="tel"]{padding:12px;border:1px solid #e5e7eb;border-radius:10px;font-size:16px}
    .check{display:flex;gap:10px;align-items:flex-start;margin-top:10px;font-size:14px}
    .check input{margin-top:2px}
    .price{font-weight:700}.hint{color:var(--muted);font-size:13px}
    .btn{appearance:none;border:0;border-radius:12px;background:#111;color:#fff;padding:12px 16px;font-weight:700;cursor:pointer}
    .btn[disabled]{opacity:.6;cursor:not-allowed}
    .note{font-size:13px;color:var(--muted)}
    .qrbox{display:none;margin-top:10px}
    .qrwrap{display:flex;gap:16px;align-items:flex-start;flex-wrap:wrap}
    .qrwrap img{width:240px;height:240px;box-shadow:var(--shadow);border-radius:12px;background:#fff}
    code{background:#f3f4f6;padding:8px;border-radius:8px;display:block;word-break:break-all}
    .tag{display:inline-block;background:#dcfce7;color:#166534;border-radius:999px;padding:4px 10px;font-size:12px;font-weight:700}
    .error{color:#dc2626;font-weight:600}
    .toast{display:none;margin-top:8px;border-left:4px solid var(--ok);background:#ecfdf5;padding:10px;border-radius:8px}
    .empty{border:1px dashed #d1d5db;border-radius:12px;padding:16px;text-align:center;color:var(--muted)}
  </style>
</head>
<body>
<div class="wrap">
  <div class="hero">
    <h1>Rezervace smyslohraní</h1>
    <p>Vyberte termín, počet míst a vyplňte kontakty. <strong>Sleva pro sourozence</strong> je pevná částka za dítě a může se lišit podle termínu.</p>
    <p class="hint" style="margin-top:6px;">Rezervace je platná i bez okamžité platby – můžete uhradit později převodem nebo hotově na místě.</p>
  </div>

  <div class="grid">
    <div class="panel">
      <h2 style="margin:0 0 10px;">1) Vyberte termín</h2>
      <div id="terms" class="term-list"></div>
      <div id="noTerms" class="empty" style="display:none;">Momentálně nejsou vypsané žádné budoucí termíny.</div>

      <div class="controls">
        <div>
          <label>Počet míst</label><br/>
          <div class="stepper">
            <button type="button" id="minus">−</button>
            <input id="qty" type="number" min="1" value="1" />
            <button type="button" id="plus">+</button>
          </div>
        </div>
        <div><span class="tag" id="leftTag">Zbývá: −</span></div>
      </div>

      <!-- Sourozenci -->
      <div id="siblingsWrap" class="check" style="display:none;">
        <input id="siblings2" type="checkbox" />
        <label for="siblings2">Jde o <strong>sourozence</strong> (uplatní se sleva – pevná částka za dítě).</label>
      </div>

      <div style="margin-top:10px">
        <label>Jméno dítěte (nebo dětí)</label>
        <input id="name" type="text" placeholder="např. Anna a Tomáš" />
      </div>
      <div style="margin-top:10px">
        <label>Telefon (povinné)</label>
        <input id="phone" type="tel" placeholder="např. 777 123 456" />
      </div>
      <div style="margin-top:10px">
        <label>E-mail pro potvrzení</label>
        <input id="email" type="email" placeholder="např. maminka@..." />
        <div class="hint">Na tento e-mail přijde potvrzení a soubor <em>.ics</em> pro kalendář.</div>
      </div>

      <!-- Způsob platby -->
      <div class="check" style="margin-top:12px;">
        <label style="font-weight:600;margin-right:12px;">Způsob platby</label>
        <div style="display:flex;gap:12px;align-items:center;flex-wrap:wrap">
          <label><input type="radio" name="pay" value="cash" checked> Hotově na místě</label>
          <label><input type="radio" name="pay" value="transfer"> Převodem (QR)</label>
        </div>
      </div>

      <!-- GDPR -->
      <div class="check">
        <input id="gdpr" type="checkbox" />
        <label for="gdpr">
          Souhlasím se <a href="https://www.smyslokoutek.cz/podminky-ochrany-osobnich-udaju/" target="_blank" rel="noopener">zpracováním osobních údajů</a>
          (Tereza Unarová, info@smyslokoutek.cz) provozovatelem Smyslokoutek pro účely vyřízení rezervace a související komunikace.
        </label>
      </div>

      <!-- Alergeny – povinné potvrzení -->
      <div class="check">
        <input id="allergenAck" type="checkbox" />
        <label for="allergenAck">
          Beru na vědomí, že lekce smyslohraní mohou obsahovat běžné alergeny (např. mouka/lepek, mléko, vejce, ořechy, sója, citrusy, potravinářská barviva, latex).
          Pokud má dítě alergii, zavazuji se informovat pořadatele <strong>před lekcí</strong>.
        </label>
      </div>

      <div style="margin-top:12px">
        <div id="price" class="price">Cena: –</div>
        <div id="discountHint" class="hint"></div>
      </div>

      <div style="margin-top:14px">
        <button id="reserveBtn" class="btn">Rezervovat a zobrazit</button>
        <div id="toast" class="toast">Rezervace uložena. Platí i bez okamžité platby – níže najdete informace k platbě.</div>
        <div id="error" class="error"></div>
      </div>
    </div>

    <div class="panel">
      <h2 style="margin:0 0 10px;">2) Informace k platbě</h2>
      <div class="hint">Hotově → informace „platba na místě“. Převodem → zobrazí se QR kód. Rezervace je potvrzena.</div>

      <div id="qrbox" class="qrbox">
        <div class="qrwrap">
          <img id="qr" alt="QR platba" />
          <div style="flex:1 1 280px">
            <div><strong>SPAYD řetězec</strong></div>
            <code id="spayd"></code>
            <div class="note">Pokud by sken nešel, použijte běžný převod a zadejte částku a VS ručně.</div>
          </div>
        </div>
      </div>

      <div id="qrEmpty" class="empty">QR kód se zobrazí po potvrzení rezervace, pokud zvolíte platbu převodem.</div>
      <div id="cashInfo" class="empty" style="display:none;">Platba <strong>hotově na místě</strong>. Rezervace je potvrzena – u pokladny nahlaste jméno a termín.</div>
    </div>
  </div>
</div>

<script>
/* ===== KONFIGURACE ===== */
const API_URL = 'https://script.google.com/macros/s/AKfycbzAJh9wVawvTfLUfsi7qqtkxyaT5Hpm69gyAlwNROW8N5S-MEIrOSW541caGaRQ5ysl_g/exec';
const IBAN = 'TVŮJ_IBAN_BEZ_MEZER';
const CURRENCY = 'CZK';
const MSG_BASE = 'SMYSLOHRANI';
const VS_PREFIX = '2509';
const POLICY_VERSION = '2025-08-28';
/* ======================== */

const el = id => document.getElementById(id);
const termsBox = el('terms'), noTerms = el('noTerms');
const qtyInput = el('qty'), leftTag = el('leftTag'), priceEl = el('price'), discHint = el('discountHint');
const btn = el('reserveBtn'), toast = el('toast'), errBox = el('error');
const qrBox = el('qrbox'), qrImg = el('qr'), spaydEl = el('spayd'), qrEmpty = el('qrEmpty'), cashInfo = el('cashInfo');
const nameEl = el('name'), emailEl = el('email'), phoneEl = el('phone'), gdprEl = el('gdpr');
const siblingsWrap = el('siblingsWrap'); const siblingsEl = document.getElementById('siblings2');
const allergenAckEl = document.getElementById('allergenAck'); // NOVÉ

let EVENTS = [], selected = null;

// ===== Helpery =====
const fmt = n => (Math.round(n*100)/100).toFixed(2);
const cz  = dt => new Date(dt).toLocaleString('cs-CZ',{dateStyle:'medium', timeStyle:'short'});
function makeVS(){ return (VS_PREFIX + String(Math.floor(Math.random()*999999)).padStart(6,'0')).slice(0,10); }
function spayd(iban, amount, msg, vs){ return ['SPD*1.0',`ACC:${iban}`,`AM:${fmt(amount)}`,`CC:${CURRENCY}`,`MSG:${encodeURIComponent(msg).toUpperCase()}`,`X-VS:${vs}`].join('*'); }
function renderQR(payload){ qrImg.src='https://quickchart.io/qr?size=240&margin=2&text='+encodeURIComponent(payload); spaydEl.textContent=payload; qrEmpty.style.display='none'; qrBox.style.display='block'; }
function sanitizeMsg(s){ let t=(s||'').normalize('NFD').replace(/[\u0300-\u036f]/g,''); t=t.replace(/[^A-Za-z0-9 .,_-]/g,' '); t=t.replace(/\s+/g,' ').trim().toUpperCase(); return t.slice(0,60); }
function formatForMsg(iso){ const d=new Date(iso); const yyyy=d.getFullYear(); const mm=String(d.getMonth()+1).padStart(2,'0'); const dd=String(d.getDate()).padStart(2,'0'); const hh=String(d.getHours()).padStart(2,'0'); const mi=String(d.getMinutes()).padStart(2,'0'); return `${yyyy}-${mm}-${dd} ${hh}:${mi}`; }
function getPaymentMethod(){ const r=document.querySelector('input[name="pay"]:checked'); return r?r.value:'transfer'; }

// Předvýpočet na klientu – pevná částka za dítě
function previewTotal(unitPrice, qty, siblingsChecked, siblingFix){
  const base = unitPrice * qty;
  const apply = (qty >= 2) && siblingsChecked && (siblingFix > 0);
  const total = apply ? (base - siblingFix * qty) : base;
  return Math.max(0, total);
}

function renderTerms(data){
  termsBox.innerHTML='';
  if(!data.length){ noTerms.style.display='block'; return; }
  noTerms.style.display='none';

  data.forEach((ev,i)=>{
    const duration = Number(ev.duration || 90);
    const b = document.createElement('button');
    b.type='button';
    b.className='term'+(i===0?' active':'');
    b.dataset.id=ev.id;
    b.dataset.price=ev.price;
    b.dataset.left=ev.left;
    b.dataset.sibling=ev.sibling_discount || 0;
    b.dataset.duration=duration;

    b.innerHTML=`
      <h3>${cz(ev.start)}</h3>
      <div class="meta">${ev.name}</div>
      <div class="meta">Délka: ${duration} min</div>
      <div class="meta">Zbývá ${ev.left} míst</div>`;

    b.onclick=()=>{
      [...termsBox.children].forEach(c=>c.classList.remove('active'));
      b.classList.add('active');
      selected = { ...ev, duration };
      updatePriceLeft();
    };

    termsBox.appendChild(b);
    if(i===0) selected = { ...ev, duration };
  });

  updatePriceLeft();
}

function updatePriceLeft(){
  if(!selected){
    priceEl.textContent='Cena: –'; leftTag.textContent='Zbývá: −'; discHint.textContent=''; siblingsWrap.style.display='none'; return;
  }
  const q = Math.max(1, parseInt(qtyInput.value||'1',10));
  const left = Number(selected.left);
  const unit = Number(selected.price || 0);
  const siblingFix = Number(selected.sibling_discount || 0);
  const durationMin = Number(selected.duration || 90);

  siblingsWrap.style.display = (q >= 2) ? 'flex' : 'none';
  const siblingsChecked = (q >= 2) && !!siblingsEl.checked;

  const total = previewTotal(unit, q, siblingsChecked, siblingFix);

  leftTag.textContent=`Zbývá: ${left} míst`;
  priceEl.textContent = `Cena: ${fmt(total)} Kč  •  Délka lekce: ${durationMin} min`;

  if(q >= 2){
    const disc = siblingsChecked ? (siblingFix * q) : 0;
    discHint.textContent = siblingsChecked
      ? `Sourozenci: sleva ${fmt(siblingFix)} Kč za dítě × ${q} = −${fmt(disc)} Kč.`
      : (siblingFix > 0
          ? `Máte 2+ míst. Zaškrtněte „sourozenci“, pokud jde o sourozence – uplatní se sleva ${fmt(siblingFix)} Kč / dítě.`
          : `Máte 2+ míst.` );
  } else {
    discHint.textContent = '';
  }
}

async function loadEvents(){
  try{
    const r=await fetch(API_URL+'?action=events');
    const data=await r.json();
    EVENTS=data;
    renderTerms(data);
  } catch {
    termsBox.innerHTML='<div class="empty">Nepodařilo se načíst termíny. Zkuste to prosím později.</div>';
  }
}

function validate(){
  errBox.textContent='';
  if(!selected){ errBox.textContent='Vyberte prosím termín.'; return false; }
  const q=Math.max(1,parseInt(qtyInput.value||'1',10));
  if(q>selected.left){ errBox.textContent=`Na vybraném termínu zbývá pouze ${selected.left} míst.`; return false; }
  const email=(emailEl.value||'').trim();
  if(!/^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(email)){ errBox.textContent='Zadejte platný e-mail.'; return false; }
  const phone=(phoneEl.value||'').trim();
  if(phone.length < 6){ errBox.textContent='Zadejte telefon (povinné pole).'; return false; }
  if(!gdprEl.checked){ errBox.textContent='Pro odeslání je nutný souhlas se zpracováním osobních údajů.'; return false; }
  if(!allergenAckEl.checked){ errBox.textContent='Pro odeslání je nutné potvrdit informaci o možných alergenech.'; return false; } // NOVÉ
  return true;
}

document.getElementById('minus').onclick = ()=>{ qtyInput.stepDown(); updatePriceLeft(); };
document.getElementById('plus').onclick  = ()=>{ qtyInput.stepUp();  updatePriceLeft(); };
qtyInput.addEventListener('input', updatePriceLeft);
siblingsEl.addEventListener('change', updatePriceLeft);
document.querySelectorAll('input[name="pay"]').forEach(r => r.addEventListener('change', ()=>{}));

btn.addEventListener('click', async ()=>{
  if(!validate()) return;
  btn.disabled=true; errBox.textContent=''; toast.style.display='none';

  const q   = Math.max(1, parseInt(qtyInput.value||'1',10));
  const pay = getPaymentMethod();
  const siblingsChecked = (q >= 2) && !!siblingsEl.checked;

  try{
    const resp = await fetch(API_URL, {
      method:'POST',
      headers:{ 'Content-Type': 'text/plain;charset=utf-8' },
      body: JSON.stringify({
        eventId: selected.id,
        eventDuration: Number(selected?.duration || 90),
        qty: q,
        name: (nameEl.value||'').trim(),
        email: (emailEl.value||'').trim(),
        phone: (phoneEl.value||'').trim(),
        paymentMethod: pay,
        siblings2: siblingsChecked,
        consent: true,
        consentAt: new Date().toISOString(),
        policyVersion: POLICY_VERSION,
        ua: navigator.userAgent,
        allergen_notice_ack: !!allergenAckEl.checked // NOVÉ
      })
    }).then(x=>x.json());

    if(!resp.ok){ errBox.textContent = (resp.error || 'Rezervace se nepodařila.'); btn.disabled=false; return; }

    // Po uložení
    toast.style.display='block';
    qrBox.style.display='none'; spaydEl.textContent=''; qrEmpty.style.display='none'; cashInfo.style.display='none';

    const totalServer = Number(resp.total || 0);

    if (pay === 'transfer') {
      const whenPlain = formatForMsg(resp.event.start);
      const dur = Number(resp?.event?.duration || selected?.duration || 90);
      const rawMsg    = `${MSG_BASE} ${whenPlain} ${q} MISTA ${dur}MIN ${(nameEl.value||'')}`;
      const msg       = sanitizeMsg(rawMsg);
      const vs        = makeVS();
      const payload   = spayd(IBAN, totalServer, msg, vs);
      renderQR(payload);
      priceEl.textContent = `Cena: ${fmt(totalServer)} Kč  •  Délka lekce: ${dur} min`;
      discHint.textContent = '';
    } else {
      cashInfo.style.display='block';
      priceEl.textContent = `Cena: ${fmt(totalServer)} Kč (platba na místě)  •  Délka lekce: ${Number(resp?.event?.duration || selected?.duration || 90)} min`;
      discHint.textContent = '';
    }

    // Refresh kapacit
    await loadEvents();
    const again = EVENTS.find(e=>e.id===resp.event.id);
    if(again){ selected={...again, duration:Number(again.duration||90)}; updatePriceLeft(); }

  }catch(e){
    errBox.textContent='Něco se pokazilo při odeslání. Zkuste to prosím znovu.';
  }finally{
    btn.disabled=false;
  }
});

loadEvents();
</script>
</body>
</html>
