<!doctype html>
<html lang="cs">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Rezervace Smyslokoutek – výběr termínu &amp; platba</title>
  <meta name="theme-color" content="#ffffff" />
  <meta name="color-scheme" content="light only" />
  <!-- [KROK 3] reCAPTCHA v3 -->
  <script src="https://www.google.com/recaptcha/api.js?render=6LcoqHcsAAAAALMALyGOCnXycEkLUDxyBzOctnCq"></script>
  <style>
    /* [KROK 3] skrýt reCAPTCHA badge – povinné uvést textovou zmínku v patičce */
    .grecaptcha-badge { visibility: hidden !important; }
    :root{
      /* 2026+ "clean + friendly" tokens */
      --bg: #f6f7fb;
      --card: #ffffff;
      --ink: #0b0b0b;
      --muted: #6b7280;
      --line: rgba(15, 23, 42, .10);
      --brand: #0ea5e9;
      --brand-ink: #075985;
      --ok: #16a34a;
      --bad: #dc2626;
      --soft: #eef2ff;
      --soft2: #f3f4f6;
      --radius-xl: 18px;
      --radius-lg: 16px;
      --radius-md: 12px;
      --radius-sm: 10px;
      --shadow: 0 10px 30px rgba(0,0,0,.08);
      --shadow2: 0 6px 18px rgba(0,0,0,.08);
      --focus: 0 0 0 4px rgba(14,165,233,.18);
    }
    html{box-sizing:border-box}
    *,*::before,*::after{box-sizing:inherit}
    html,body{
      margin:0;
      background:var(--bg);
      color:var(--ink);
      font-family: system-ui, -apple-system, Segoe UI, Inter, Roboto, Arial, sans-serif;
      -webkit-font-smoothing: antialiased;
      text-rendering: optimizeLegibility;
    }
    a{color: var(--brand-ink); text-decoration: underline; text-underline-offset: 2px}
    a:hover{color: #0369a1}
    .wrap{
      max-width: 1040px;
      margin: 0 auto;
      padding: 22px 18px 40px;
    }
    /* ===== Header 2026+ ===== */
    .hero{
      background: var(--card);
      border: 1px solid var(--line);
      border-radius: var(--radius-xl);
      box-shadow: var(--shadow);
      padding: 18px 20px 16px;
      margin-bottom: 14px;
    }
    .hero-top{
      display:flex;
      gap: 14px;
      align-items:flex-start;
      justify-content: space-between;
      flex-wrap: wrap;
    }
    .hero h1{
      margin: 0 0 6px;
      font-size: 22px;
      letter-spacing: -0.25px;
    }
    .hero p{
      margin: 0;
      color: var(--muted);
      line-height: 1.45;
    }
    .hero .hint{
      margin-top: 8px;
      font-size: 13px;
      color: var(--muted);
    }
    .steps{
      display:flex;
      gap: 10px;
      align-items:center;
      flex-wrap: wrap;
      justify-content:flex-end;
    }
    .step{
      display:inline-flex;
      align-items:center;
      gap: 8px;
      padding: 8px 10px;
      border-radius: 999px;
      border: 1px solid rgba(15,23,42,.10);
      background: rgba(243,244,246,.55);
      font-size: 12px;
      color: #111827;
      font-weight: 750;
      letter-spacing: .1px;
      white-space: nowrap;
    }
    .dot{
      width: 9px;
      height: 9px;
      border-radius: 999px;
      background: rgba(107,114,128,.45);
      box-shadow: inset 0 0 0 1px rgba(0,0,0,.10);
    }
    .step.is-active{
      border-color: rgba(14,165,233,.35);
      background: rgba(238,242,255,.75);
    }
    .step.is-active .dot{
      background: var(--brand);
      box-shadow: none;
    }
    .grid{
      display: grid;
      grid-template-columns: 2fr 1fr;
      gap: 14px;
      align-items: start;
    }
    @media (max-width: 940px){
      .grid{grid-template-columns: 1fr}
    }
    .panel{
      background: var(--card);
      border: 1px solid var(--line);
      border-radius: var(--radius-xl);
      box-shadow: var(--shadow2);
      padding: 18px;
      overflow: hidden;
    }
    .panel h2{
      margin: 0 0 12px;
      font-size: 18px;
      letter-spacing: -0.2px;
    }
    /* Sticky payment on desktop (will be disabled in iframe mode by JS) */
    .panel--sticky{
      position: sticky;
      top: 14px;
    }
    @media (max-width: 940px){
      .panel--sticky{position: static}
    }
    .iframe-mode .panel--sticky{ position: static !important; }
    /* Inputs */
    label{font-weight: 650; letter-spacing: -0.1px}
    input[type="text"], input[type="email"], input[type="tel"], input[type="number"]{
      width: 100%;
      max-width: 100%;
      display: block;
      padding: 12px 12px;
      border: 1px solid rgba(15, 23, 42, .12);
      border-radius: var(--radius-sm);
      font-size: 16px; /* iOS anti-zoom */
      background: #fff;
      outline: none;
      -webkit-appearance: none;
      appearance: none;
      transition: box-shadow .12s ease, border-color .12s ease, transform .12s ease;
    }
    input:focus{
      border-color: rgba(14,165,233,.45);
      box-shadow: var(--focus);
    }
    /* Term list cards */
    .term-list{
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 10px;
    }
    @media (max-width: 740px){
      .term-list{grid-template-columns: 1fr}
    }
    .term{
      border: 1px solid rgba(15, 23, 42, .12);
      border-radius: var(--radius-lg);
      padding: 14px 14px 12px;
      cursor: pointer;
      background: #fff;
      transition: transform .12s ease, box-shadow .12s ease, border-color .12s ease, background .12s ease;
      text-align: left;
    }
    .term:hover{
      border-color: rgba(14,165,233,.35);
      background: linear-gradient(180deg, #ffffff 0%, rgba(238,242,255,.55) 100%);
      transform: translateY(-1px);
      box-shadow: 0 10px 26px rgba(2, 132, 199, .10);
    }
    .term:focus-visible{
      outline: none;
      box-shadow: var(--focus);
      border-color: rgba(14,165,233,.55);
    }
    .term.active{
      border-color: rgba(14,165,233,.75);
      box-shadow: 0 10px 28px rgba(14,165,233,.16);
      background: linear-gradient(180deg, rgba(238,242,255,.72) 0%, #ffffff 100%);
    }
    .term h3{
      margin: 0 0 8px;
      font-size: 15.5px;
      letter-spacing: -0.1px;
    }
    .term .meta{
      font-size: 13px;
      color: var(--muted);
      line-height: 1.35;
    }
    /* ===== Controls (FIX ALIGNMENT + FIX STEPPER WIDTH) ===== */
    .controls{
      display:grid;
      grid-template-columns: 1fr auto;
      gap: 12px;
      align-items:end; /* ✅ bottom align */
      margin: 12px 0 10px;
      padding: 12px;
      border-radius: var(--radius-lg);
      background: rgba(243,244,246,.6);
      border: 1px solid rgba(15,23,42,.07);
    }
    .controls > div:first-child{
      display:flex;
      flex-direction:column;
      gap: 6px;
      min-width: 0;
    }
    @media (max-width: 520px){
      .controls{
        grid-template-columns: 1fr;
        align-items:start;
      }
    }
    .stepper{
      display: inline-flex;       /* ✅ */
      align-items: center;
      width: fit-content;         /* ✅ neroste do šířky */
      max-width: 100%;
      border: 1px solid rgba(15,23,42,.12);
      border-radius: 14px;
      overflow: hidden;
      background: #fff;
    }
    .stepper button{
      flex: 0 0 42px;             /* ✅ */
      border: 0;
      background: #f3f4f6;
      width: 42px;
      height: 42px;
      font-size: 20px;
      cursor: pointer;
      color: #111827;
      transition: background .12s ease;
    }
    .stepper button:hover{background:#e5e7eb}
    .stepper button:focus-visible{outline:none; box-shadow: inset var(--focus)}
    .stepper input{
      flex: 0 0 74px;             /* ✅ fixní šířka inputu */
      width: 74px;
      min-width: 74px;
      height: 42px;
      border: 0;
      text-align: center;
      font-size: 16px;
      outline: none;
      padding: 0;                 /* ✅ */
      display: block;
    }
    /* zruš default spinnery (čistější UI) */
    .stepper input::-webkit-outer-spin-button,
    .stepper input::-webkit-inner-spin-button{ -webkit-appearance: none; margin: 0; }
    .stepper input[type=number]{ -moz-appearance: textfield; }
    .tag{
      display: inline-flex;
      align-items: center;
      gap: 6px;
      background: #dcfce7;
      color: #166534;
      border: 1px solid rgba(22,163,74,.20);
      border-radius: 999px;
      padding: 6px 10px;
      font-size: 12px;
      font-weight: 800;
      letter-spacing: .2px;
      justify-self:start;
      align-self:end;             /* ✅ */
      white-space: nowrap;
      margin-bottom: 2px;         /* ✅ optické dorovnání vůči stepperu */
    }
    @media (max-width: 520px){
      .tag{align-self:start; margin-bottom: 0;}
    }
    /* Checks */
    .check{
      display: flex;
      gap: 10px;
      align-items: flex-start;
      margin-top: 10px;
      font-size: 14px;
      line-height: 1.35;
      color: #111827;
    }
    .check input{
      margin-top: 3px;
      width: 18px;
      height: 18px;
    }
    /* Coupon row */
    .coupon-row{
      display: flex;
      gap: 8px;
      flex-wrap: wrap;
      align-items: center;
    }
    .coupon-row input{flex: 1 1 220px}
    /* Buttons */
    .btn{
      appearance: none;
      border: 0;
      border-radius: 14px;
      background: #0b0b0b;
      color: #fff;
      padding: 12px 16px;
      font-weight: 850;
      cursor: pointer;
      transition: transform .10s ease, box-shadow .10s ease, opacity .10s ease, background .10s ease;
      letter-spacing: .1px;
    }
    .btn:hover{
      transform: translateY(-1px);
      box-shadow: 0 12px 26px rgba(0,0,0,.14);
    }
    .btn:active{transform: translateY(0px)}
    .btn:focus-visible{outline:none; box-shadow: var(--focus), 0 12px 26px rgba(0,0,0,.14)}
    .btn[disabled]{opacity:.55; cursor:not-allowed; transform:none; box-shadow:none}
    .btn--muted{ background: #6b7280; }
    .btn--muted:hover{background:#4b5563}
    .hint{color: var(--muted); font-size: 13px; line-height: 1.4}
    .note{font-size: 13px; color: var(--muted); line-height: 1.4}
    .price{font-weight: 850; letter-spacing: -0.1px}
    .error{
      color: var(--bad);
      font-weight: 700;
      margin-top: 8px;
    }
    .toast{
      display: none;
      margin-top: 10px;
      border-left: 4px solid var(--ok);
      background: #ecfdf5;
      padding: 10px 12px;
      border-radius: 12px;
      color: #065f46;
      border: 1px solid rgba(16,185,129,.18);
    }
    .empty{
      border: 1px dashed rgba(15,23,42,.22);
      border-radius: 14px;
      padding: 16px;
      text-align: center;
      color: var(--muted);
      background: rgba(255,255,255,.65);
    }
    /* Payment panel */
    .pay-card{
      padding: 12px;
      border-radius: 16px;
      border: 1px solid rgba(15,23,42,.08);
      background: rgba(243,244,246,.55);
      margin-top: 10px;
    }
    .qrbox{display:none;margin-top:10px}
    .qrwrap{display:flex;gap:14px;align-items:flex-start;flex-wrap:wrap}
    .qrwrap img{
      width: 240px;
      height: 240px;
      box-shadow: var(--shadow2);
      border-radius: 16px;
      background:#fff;
      border: 1px solid rgba(15,23,42,.08);
    }
    code{
      background:#ffffff;
      border: 1px solid rgba(15,23,42,.10);
      padding: 10px;
      border-radius: 12px;
      display:block;
      word-break: break-all;
      font: 12px/1.45 ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", monospace;
      color:#111827;
    }
    /* ===== Summary card (Right panel) ===== */
    .summary{
      margin-top: 12px;
      padding: 12px;
      border-radius: 16px;
      border: 1px solid rgba(15,23,42,.08);
      background: rgba(238,242,255,.55);
    }
    .summary h3{
      margin: 0 0 10px;
      font-size: 13px;
      letter-spacing: .2px;
      text-transform: uppercase;
      color: #111827;
    }
    .sum-row{
      display:flex;
      justify-content:space-between;
      gap: 10px;
      padding: 8px 0;
      border-top: 1px solid rgba(15,23,42,.08);
      font-size: 14px;
      color: #111827;
    }
    .sum-row:first-of-type{border-top:0}
    .sum-k{color: var(--muted)}
    .sum-v{font-weight: 750; text-align:right}
    .pill{
      display:inline-flex;
      align-items:center;
      gap: 8px;
      padding: 8px 10px;
      border-radius: 14px;
      border: 1px solid rgba(15,23,42,.08);
      background: rgba(255,255,255,.65);
      font-size: 13px;
      color: #111827;
      margin-top: 10px;
    }
    .pill .dot{width:8px;height:8px}
    /* honeypot */
    .hp-field{
      position:absolute !important;
      left:-99999px !important;
      top:auto !important;
      width:1px !important;
      height:1px !important;
      overflow:hidden !important;
    }
    /* Mobile spacing */
    @media (max-width: 520px){
      .wrap{padding: 16px 12px 30px}
      .hero{padding: 16px}
      .panel{padding: 14px}
      .term{padding: 12px}
      .qrwrap img{width: 220px; height: 220px}
      .steps{justify-content:flex-start}
    }
    /* Hide top progress steps completely (1) Termín / (2) Kontakty / (3) Platba */
.steps{
  display: none !important;
}
  </style>
</head>
<body>
  <div class="wrap">
    <div class="hero">
      <div class="hero-top">
        <div>
          <h1>Rezervace smyslohraní</h1>
          <p>Vyberte termín, počet míst a vyplňte kontakty. <strong>Sleva pro sourozence</strong> je pevná částka za dítě a může se lišit podle termínu.</p>
          <p class="hint">Rezervace je platná i bez okamžité platby – můžete uhradit později převodem nebo hotově na místě.</p>
        </div>
        <div class="steps" aria-label="Postup rezervace">
          <div class="step is-active" id="step1"><span class="dot" aria-hidden="true"></span> 1) Termín</div>
          <div class="step" id="step2"><span class="dot" aria-hidden="true"></span> 2) Kontakty</div>
          <div class="step" id="step3"><span class="dot" aria-hidden="true"></span> 3) Platba</div>
        </div>
      </div>
    </div>
    <div class="grid">
      <div class="panel">
        <h2>1) Vyberte termín</h2>
        <div id="terms" class="term-list"></div>
        <div id="noTerms" class="empty" style="display:none;">Momentálně nejsou vypsané žádné budoucí termíny.</div>
        <div class="controls">
          <div>
            <label>Počet míst</label>
            <div class="stepper">
              <button type="button" id="minus" aria-label="Snížit počet míst">−</button>
              <input id="qty" type="number" min="1" value="1" inputmode="numeric" />
              <button type="button" id="plus" aria-label="Zvýšit počet míst">+</button>
            </div>
          </div>
          <div><span class="tag" id="leftTag">Zbývá: −</span></div>
        </div>
        <!-- Sourozenci -->
        <div id="siblingsWrap" class="check" style="display:none;">
          <input id="siblings2" type="checkbox" />
          <label for="siblings2">Jde o <strong>sourozence</strong> (uplatní se sleva – pevná částka za dítě).</label>
        </div>
        <div style="margin-top:12px">
          <label>Jméno dítěte (nebo dětí)</label>
          <input id="name" type="text" placeholder="např. Anna a Tomáš" autocomplete="name" />
        </div>
        <div style="margin-top:12px">
          <label>Telefon (povinné)</label>
          <input id="phone" type="tel" placeholder="např. 777 123 456" inputmode="tel" autocomplete="tel" />
        </div>
        <div style="margin-top:12px">
          <label>E-mail pro potvrzení</label>
          <input id="email" type="email" placeholder="např. maminka@..." inputmode="email" autocomplete="email" />
          <div class="hint" style="margin-top:6px">Na tento e-mail přijde potvrzení a soubor <em>.ics</em> pro kalendář.</div>
        </div>
        <!-- honeypot (bot trap) -->
        <div class="hp-field" aria-hidden="true">
          <label for="website">Website</label>
          <input id="website" type="text" autocomplete="off" tabindex="-1" />
        </div>
        <!-- Kupon -->
        <div style="margin-top:12px">
          <label>Slevový kód</label>
          <div class="coupon-row" style="margin-top:6px">
            <input id="coupon" type="text" placeholder="např. ABC20" autocomplete="off" />
            <button id="applyCouponBtn" type="button" class="btn" style="padding:11px 14px">Uplatnit</button>
            <button id="removeCouponBtn" type="button" class="btn btn--muted" style="padding:11px 14px; display:none;">Zrušit kupon</button>
          </div>
          <div id="couponMsg" class="hint" style="margin-top:6px"></div>
        </div>
        <!-- Způsob platby -->
        <div class="check" style="margin-top:14px;">
          <label style="font-weight:650;margin-right:10px;">Způsob platby</label>
          <div style="display:flex;gap:12px;align-items:center;flex-wrap:wrap">
            <label style="font-weight:600"><input type="radio" name="pay" value="cash" checked> Hotově na místě</label>
            <label style="font-weight:600"><input type="radio" name="pay" value="transfer"> Převodem (QR)</label>
          </div>
        </div>
        <!-- GDPR -->
        <div class="check">
          <input id="gdpr" type="checkbox" />
          <label for="gdpr">
            Souhlasím se <a href="https://www.smyslokoutek.cz/podminky-ochrany-osobnich-udaju/" target="_blank" rel="noopener">zpracováním osobních údajů</a>
            (Tereza Unarová, info@smyslokoutek.cz) provozovatelem Smyslokoutek pro účely vyřízení rezervace a související komunikace.
          </label>
        </div>
        <!-- Alergeny -->
        <div class="check">
          <input id="allergenAck" type="checkbox" />
          <label for="allergenAck">
            Beru na vědomí, že lekce smyslohraní mohou obsahovat běžné alergeny (např. mouka/lepek, mléko, vejce, ořechy, sója, citrusy, potravinářská barviva, latex).
            Informace o alergenech budou vždy před lekcí dostupné u pořadatele.
          </label>
        </div>
        <div class="pay-card" style="margin-top:14px">
          <div id="price" class="price">Cena: –</div>
          <div id="discountHint" class="hint" style="margin-top:4px"></div>
        </div>
        <div style="margin-top:14px">
          <button id="reserveBtn" class="btn" style="width:100%">Rezervovat a zobrazit</button>
          <div id="toast" class="toast">Rezervace uložena. Platí i bez okamžité platby – níže najdete informace k platbě.</div>
          <div id="error" class="error" role="alert" aria-live="polite"></div>
        </div>
      </div>
      <div class="panel panel--sticky">
        <h2>2) Informace k platbě</h2>
        <div class="hint">Hotově → informace „platba na místě". Převodem → zobrazí se QR kód. Rezervace je potvrzena.</div>
        <!-- Summary (2026+) -->
        <div class="summary" aria-label="Shrnutí rezervace">
          <h3>Shrnutí</h3>
          <div class="sum-row">
            <div class="sum-k">Termín</div>
            <div class="sum-v" id="sumWhen">—</div>
          </div>
          <div class="sum-row">
            <div class="sum-k">Počet míst</div>
            <div class="sum-v" id="sumQty">—</div>
          </div>
          <div class="sum-row">
            <div class="sum-k">Celkem</div>
            <div class="sum-v" id="sumTotal">—</div>
          </div>
          <div class="pill" id="sumPay">
            <span class="dot" aria-hidden="true"></span>
            <span id="sumPayText">Způsob platby: —</span>
          </div>
        </div>
        <div id="qrbox" class="qrbox">
          <div class="qrwrap" style="margin-top:12px">
            <img id="qr" alt="QR platba" />
            <div style="flex:1 1 280px">
              <div style="font-weight:800; letter-spacing:-0.1px; margin-bottom:8px">SPAYD řetězec</div>
              <code id="spayd"></code>
              <div class="note" style="margin-top:8px">Pokud by sken nešel, použijte běžný převod a zadejte částku a VS ručně.</div>
            </div>
          </div>
        </div>
        <div id="qrEmpty" class="empty" style="margin-top:12px">QR kód se zobrazí po potvrzení rezervace, pokud zvolíte platbu převodem.</div>
        <div id="cashInfo" class="empty" style="display:none;margin-top:12px">Platba <strong>hotově na místě</strong>. Rezervace je potvrzena – u pokladny nahlaste jméno a termín.</div>
      </div>
    </div>
  </div>
<script>
/* ===== KONFIGURACE ===== */
const API_URL = 'https://script.google.com/macros/s/AKfycbyVS2z-SG1H02MLcAbXGRTeWiCyHh7ii7pBMLUu0Rk-3Qsfr3MI86skTzW4wgNN0ATRWg/exec';
/* [KROK 4] IBAN odstraněn z frontendu – bude se číst z odpovědi serveru (resp.iban) */
const CURRENCY = 'CZK';
const MSG_BASE = 'SMYSLOHRANI';
const VS_PREFIX = '2509';
const POLICY_VERSION = '2025-08-28';
/* [KROK 3] reCAPTCHA v3 site key */
const RECAPTCHA_SITE_KEY = '6LcoqHcsAAAAALMALyGOCnXycEkLUDxyBzOctnCq';
/* ======================== */
const el = id => document.getElementById(id);
const termsBox = el('terms'), noTerms = el('noTerms');
const qtyInput = el('qty'), leftTag = el('leftTag'), priceEl = el('price'), discHint = el('discountHint');
const btn = el('reserveBtn'), toast = el('toast'), errBox = el('error');
const qrBox = el('qrbox'), qrImg = el('qr'), spaydEl = el('spayd'), qrEmpty = el('qrEmpty'), cashInfo = el('cashInfo');
const nameEl = el('name'), emailEl = el('email'), phoneEl = el('phone'), gdprEl = el('gdpr');
const siblingsWrap = el('siblingsWrap'); const siblingsEl = document.getElementById('siblings2');
const allergenAckEl = document.getElementById('allergenAck');
const websiteEl = document.getElementById('website'); // honeypot
// Summary UI
const sumWhen = el('sumWhen');
const sumQty  = el('sumQty');
const sumTotal = el('sumTotal');
const sumPayText = el('sumPayText');
const sumPayPill = el('sumPay');
// Step UI
const step1 = el('step1'), step2 = el('step2'), step3 = el('step3');
// KUPON: selektory + stav
const couponEl = document.getElementById('coupon');
const couponMsg = document.getElementById('couponMsg');
const applyCouponBtn = document.getElementById('applyCouponBtn');
const removeCouponBtn = document.getElementById('removeCouponBtn');
let APPLIED_COUPON = null;
let EVENTS = [], selected = null;
/* ===== IFRAME MODE DETECTION ===== */
function isIframe(){
  try { return window.self !== window.top; } catch { return true; }
}
function hasUtmIframe(){
  try { return /utm_source=shoptet/i.test(window.location.search); } catch { return false; }
}
(function applyIframeMode(){
  const iframeMode = isIframe() || hasUtmIframe();
  if (iframeMode) document.documentElement.classList.add('iframe-mode');
})();
// ===== IFRAME AUTO-RESIZE (pro Shoptet) =====
(function iframeAutoResize(){
  function getDocHeight(){
    const b = document.body, d = document.documentElement;
    return Math.max(
      b ? b.scrollHeight : 0,
      b ? b.offsetHeight : 0,
      d ? d.scrollHeight : 0,
      d ? d.offsetHeight : 0
    );
  }
  function postHeight(){
    try{
      const h = getDocHeight();
      window.parent && window.parent.postMessage({
        type: 'SMYSLOKOUTEK_IFRAME_HEIGHT',
        height: h,
        href: window.location.href
      }, '*');
    } catch {}
  }
  window.addEventListener('load', postHeight);
  window.addEventListener('resize', postHeight);
  if (window.ResizeObserver){
    const ro = new ResizeObserver(() => postHeight());
    ro.observe(document.documentElement);
  } else {
    setInterval(postHeight, 800);
  }
  window.__postIframeHeight = postHeight;
})();
// ===== Helpery =====
const fmt = n => (Math.round(n*100)/100).toFixed(2);
const kc  = n => String(Math.ceil(Math.max(0, Number(n||0))));
const cz  = dt => new Date(dt).toLocaleString('cs-CZ',{dateStyle:'medium', timeStyle:'short'});
function makeVS(){ return (VS_PREFIX + String(Math.floor(Math.random()*999999)).padStart(6,'0')).slice(0,10); }
function spayd(iban, amount, msg, vs){ return ['SPD*1.0',`ACC:${iban}`,`AM:${fmt(amount)}`,`CC:${CURRENCY}`,`MSG:${encodeURIComponent(msg).toUpperCase()}`,`X-VS:${vs}`].join('*'); }
function sanitizeMsg(s){
  let t=(s||'').normalize('NFD').replace(/[\u0300-\u036f]/g,'');
  t=t.replace(/[^A-Za-z0-9 .,_-]/g,' ');
  t=t.replace(/\s+/g,' ').trim().toUpperCase();
  return t.slice(0,60);
}
function formatForMsg(iso){
  const d=new Date(iso);
  const yyyy=d.getFullYear();
  const mm=String(d.getMonth()+1).padStart(2,'0');
  const dd=String(d.getDate()).padStart(2,'0');
  const hh=String(d.getHours()).padStart(2,'0');
  const mi=String(d.getMinutes()).padStart(2,'0');
  return `${yyyy}-${mm}-${dd} ${hh}:${mi}`;
}
function safeStr(s, max=500){
  const t=String(s||'');
  return t.length>max ? t.slice(0,max) : t;
}
function normalizePhone(p){ return String(p||'').trim().replace(/\s+/g,''); }
function getPaymentMethod(){
  const r=document.querySelector('input[name="pay"]:checked');
  return r?r.value:'transfer';
}
function setStep(n){
  [step1,step2,step3].forEach(x=>x.classList.remove('is-active'));
  if(n===1) step1.classList.add('is-active');
  if(n===2) step2.classList.add('is-active');
  if(n===3) step3.classList.add('is-active');
}
function setSummary({whenText='—', qty='—', total='—', pay='—'}){
  sumWhen.textContent = whenText;
  sumQty.textContent = qty;
  sumTotal.textContent = total;
  sumPayText.textContent = `Způsob platby: ${pay}`;
  const dot = sumPayPill.querySelector('.dot');
  if(dot){
    dot.style.background = pay.includes('QR') ? 'var(--brand)' : 'rgba(22,163,74,.75)';
  }
}
function renderQR(payload){
  qrImg.src='https://quickchart.io/qr?size=240&margin=2&text='+encodeURIComponent(payload);
  spaydEl.textContent=payload;
  qrEmpty.style.display='none';
  qrBox.style.display='block';
  cashInfo.style.display='none';
  setStep(3);
  window.__postIframeHeight && window.__postIframeHeight();
}
function showCash(){
  qrBox.style.display='none';
  qrEmpty.style.display='none';
  cashInfo.style.display='block';
  setStep(3);
  window.__postIframeHeight && window.__postIframeHeight();
}
// ===== Idempotency key =====
function uuidv4(){
  return 'xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx'.replace(/[xy]/g, c=>{
    const r = Math.random()*16|0, v = c==='x'?r:(r&0x3|0x8);
    return v.toString(16);
  });
}
function getIdemKey(){
  let k = sessionStorage.getItem('idemKey');
  if (!k){ k = uuidv4()+uuidv4(); sessionStorage.setItem('idemKey', k); }
  return k;
}
function rotateIdemKey(){ sessionStorage.removeItem('idemKey'); }
// ===== Serverový náhled ceny =====
async function previewWith(code){
  if (!selected) return null;
  const q = Math.max(1, parseInt(qtyInput.value||'1',10));
  const siblingsChecked = (q >= 2) && !!siblingsEl.checked;
  const params = new URLSearchParams({
    action:'price',
    eventId: selected.id,
    qty: String(q),
    siblings2: String(siblingsChecked),
    couponCode: (code||'').trim()
  });
  const r = await fetch(API_URL+'?'+params.toString(), { method:'GET', cache:'no-store' });
  return r.json();
}
function showBreakdown(calc){
  if (!calc || !calc.ok){
    priceEl.textContent='Cena: –';
    discHint.textContent='';
    setSummary({
      whenText: selected ? cz(selected.start) : '—',
      qty: qtyInput.value || '—',
      total: '—',
      pay: getPaymentMethod()==='transfer'?'Převodem (QR)':'Hotově na místě'
    });
    return;
  }
  const parts = [];
  parts.push(`Základ: ${kc(calc.base||0)} Kč`);
  if (calc.siblingsDisc) parts.push(`Sourozenci: −${kc(calc.siblingsDisc)} Kč`);
  if (calc.couponDisc)   parts.push(`Kupon: −${kc(calc.couponDisc)} Kč`);
  priceEl.textContent = `Cena: ${kc(calc.total||0)} Kč  •  Délka lekce: ${Number(selected?.duration||90)} min`;
  discHint.textContent = parts.join(' • ');
  const pay = getPaymentMethod()==='transfer' ? 'Převodem (QR)' : 'Hotově na místě';
  setSummary({
    whenText: cz(selected.start),
    qty: `${Math.max(1, parseInt(qtyInput.value||'1',10))}`,
    total: `${kc(calc.total||0)} Kč`,
    pay
  });
  window.__postIframeHeight && window.__postIframeHeight();
}
async function refreshPricePreview(){
  if (!selected){
    priceEl.textContent='Cena: –';
    discHint.textContent='';
    setSummary({ whenText:'—', qty:'—', total:'—', pay:getPaymentMethod()==='transfer'?'Převodem (QR)':'Hotově na místě' });
    return;
  }
  const q = Math.max(1, parseInt(qtyInput.value||'1',10));
  leftTag.textContent = `Zbývá: ${Number(selected.left)} míst`;
  siblingsWrap.style.display = (q >= 2) ? 'flex' : 'none';
  const hasContacts = (emailEl.value||'').trim() && normalizePhone(phoneEl.value||'').length >= 6;
  setStep(hasContacts ? 2 : 1);
  couponMsg.textContent = '';
  const code = APPLIED_COUPON ? APPLIED_COUPON.code : (couponEl.value||'').trim();
  try{
    const res = await previewWith(code);
    if (!res || !res.ok){
      if (APPLIED_COUPON){
        APPLIED_COUPON = null;
        removeCouponBtn.style.display='none';
        applyCouponBtn.style.display='inline-block';
        couponMsg.textContent = (res && res.error) ? `Kupon zrušen: ${res.error}` : 'Kupon zrušen.';
        const noCoupon = await previewWith('');
        if (noCoupon && noCoupon.ok) showBreakdown(noCoupon);
      } else {
        const noCoupon = await previewWith('');
        if (noCoupon && noCoupon.ok) showBreakdown(noCoupon);
        if (res && res.error) couponMsg.textContent = res.error;
      }
      window.__postIframeHeight && window.__postIframeHeight();
      return;
    }
    showBreakdown(res);
    if (APPLIED_COUPON){
      couponMsg.textContent = `Kupon „${APPLIED_COUPON.code}" je uplatněn.`;
    } else if (code) {
      couponMsg.textContent = 'Kupon je platný – klikněte na „Uplatnit".';
    }
    window.__postIframeHeight && window.__postIframeHeight();
  } catch(e){
    // ticho – jen UI
  }
}
// ===== Render termínů =====
function renderTerms(data){
  termsBox.innerHTML='';
  if(!data.length){
    noTerms.style.display='block';
    window.__postIframeHeight && window.__postIframeHeight();
    return;
  }
  noTerms.style.display='none';
  data.forEach((ev,i)=>{
    const duration = Number(ev.duration || 90);
    const b = document.createElement('button');
    b.type='button';
    b.className='term'+(i===0?' active':'');
    b.dataset.id=ev.id;
    b.innerHTML=`
      <h3>${cz(ev.start)}</h3>
      <div class="meta">${ev.name}</div>
      <div class="meta">Délka: ${duration} min</div>
      <div class="meta">Zbývá ${ev.left} míst</div>`;
    b.onclick=()=>{
      [...termsBox.children].forEach(c=>c.classList.remove('active'));
      b.classList.add('active');
      selected = { ...ev, duration };
      refreshPricePreview();
    };
    termsBox.appendChild(b);
    if(i===0) selected = { ...ev, duration };
  });
  refreshPricePreview();
  window.__postIframeHeight && window.__postIframeHeight();
}
async function loadEvents(){
  try{
    const r=await fetch(API_URL+'?action=events', { method:'GET', cache:'no-store' });
    const data=await r.json();
    EVENTS=data.items ? data.items : data;
    renderTerms(EVENTS);
  } catch {
    termsBox.innerHTML='<div class="empty">Nepodařilo se načíst termíny. Zkuste to prosím později.</div>';
    window.__postIframeHeight && window.__postIframeHeight();
  }
}
// ===== Validace =====
function validate(){
  errBox.textContent='';
  if(!selected){ errBox.textContent='Vyberte prosím termín.'; return false; }
  const q=Math.max(1,parseInt(qtyInput.value||'1',10));
  if(q>selected.left){ errBox.textContent=`Na vybraném termínu zbývá pouze ${selected.left} míst.`; return false; }
  const email=(emailEl.value||'').trim();
  if(!/^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(email)){ errBox.textContent='Zadejte platný e-mail.'; return false; }
  const phone=normalizePhone(phoneEl.value||'');
  if(phone.length < 6){ errBox.textContent='Zadejte telefon (povinné pole).'; return false; }
  if(!gdprEl.checked){ errBox.textContent='Pro odeslání je nutný souhlas se zpracováním osobních údajů.'; return false; }
  if(!allergenAckEl.checked){ errBox.textContent='Pro odeslání je nutné potvrdit informaci o možných alergenech.'; return false; }
  if ((websiteEl.value||'').trim()){
    errBox.textContent='Formulář se nepodařilo odeslat. Zkuste to prosím znovu.';
    return false;
  }
  return true;
}
// ===== Ovládání =====
document.getElementById('minus').onclick = ()=>{ qtyInput.stepDown(); refreshPricePreview(); };
document.getElementById('plus').onclick  = ()=>{ qtyInput.stepUp();  refreshPricePreview(); };
qtyInput.addEventListener('input', refreshPricePreview);
siblingsEl.addEventListener('change', refreshPricePreview);
emailEl.addEventListener('input', refreshPricePreview);
phoneEl.addEventListener('input', refreshPricePreview);
document.querySelectorAll('input[name="pay"]').forEach(r => r.addEventListener('change', refreshPricePreview));
// KUPON: uplatnit / zrušit
applyCouponBtn.addEventListener('click', async ()=>{
  const code = (couponEl.value||'').trim();
  if (!code){ couponMsg.textContent='Zadejte kód.'; window.__postIframeHeight && window.__postIframeHeight(); return; }
  const res = await previewWith(code);
  if (!res || !res.ok){
    couponMsg.textContent = (res && res.error) ? res.error : 'Kupon nelze použít.';
    window.__postIframeHeight && window.__postIframeHeight();
    return;
  }
  APPLIED_COUPON = { code };
  couponMsg.textContent = `Kupon „${code}" byl uplatněn.`;
  applyCouponBtn.style.display='none';
  removeCouponBtn.style.display='inline-block';
  showBreakdown(res);
});
removeCouponBtn.addEventListener('click', async ()=>{
  APPLIED_COUPON = null;
  removeCouponBtn.style.display='none';
  applyCouponBtn.style.display='inline-block';
  couponMsg.textContent = 'Kupon byl zrušen.';
  const res = await previewWith('');
  if (res && res.ok) showBreakdown(res);
  window.__postIframeHeight && window.__postIframeHeight();
});
// ===== Odeslání =====
btn.addEventListener('click', async ()=>{
  if(!validate()){ window.__postIframeHeight && window.__postIframeHeight(); return; }
  btn.disabled=true; errBox.textContent=''; toast.style.display='none';
  const q   = Math.max(1, parseInt(qtyInput.value||'1',10));
  const pay = getPaymentMethod();
  const siblingsChecked = (q >= 2) && !!siblingsEl.checked;
  const idemKey = getIdemKey();
  /* [KROK 3] reCAPTCHA v3 – získáme token před odesláním */
  let recaptchaToken = '';
  try {
    recaptchaToken = await grecaptcha.execute(RECAPTCHA_SITE_KEY, {action: 'book'});
  } catch(rcErr) {
    console.warn('reCAPTCHA token failed:', rcErr);
  }
  const payload = {
    eventId: selected.id,
    eventDuration: Number(selected?.duration || 90),
    qty: q,
    name: safeStr((nameEl.value||'').trim(), 120),
    email: safeStr((emailEl.value||'').trim(), 180),
    phone: safeStr(normalizePhone(phoneEl.value||''), 24),
    paymentMethod: pay,
    siblings2: siblingsChecked,
    consent: true,
    consentAt: new Date().toISOString(),
    policyVersion: POLICY_VERSION,
    /* [KROK 7] ua odstraněn – GDPR: nepotřebný osobní údaj */
    allergen_notice_ack: !!allergenAckEl.checked,
    website: safeStr((websiteEl.value||'').trim(), 120),
    idempotencyKey: idemKey,
    couponCode: APPLIED_COUPON ? APPLIED_COUPON.code : '',
    recaptchaToken: recaptchaToken  /* [KROK 3] */
  };
  try{
    const resp = await fetch(API_URL, {
      method:'POST',
      headers:{ 'Content-Type': 'text/plain;charset=utf-8' },
      body: JSON.stringify(payload)
    }).then(x=>x.json());
    if(!resp.ok){
      errBox.textContent = (resp.error || 'Rezervace se nepodařila.');
      btn.disabled=false;
      window.__postIframeHeight && window.__postIframeHeight();
      return;
    }
    rotateIdemKey();
    toast.style.display='block';
    qrBox.style.display='none';
    spaydEl.textContent='';
    qrEmpty.style.display='none';
    cashInfo.style.display='none';
    const totalServer = Number(resp.total || 0);
    const payLabel = pay === 'transfer' ? 'Převodem (QR)' : 'Hotově na místě';
    setSummary({
      whenText: cz(resp.event.start),
      qty: `${q}`,
      total: `${kc(totalServer)} Kč`,
      pay: payLabel
    });
    if (pay === 'transfer') {
      const whenPlain = formatForMsg(resp.event.start);
      const dur = Number(resp?.event?.duration || selected?.duration || 90);
      const rawMsg = `${MSG_BASE} ${whenPlain} ${q} MISTA ${dur}MIN ${(nameEl.value||'')}`;
      const msg = sanitizeMsg(rawMsg);
      const vs  = makeVS();
      /* [KROK 4] IBAN se čte z odpovědi serveru místo z konstanty */
      const payloadSpayd = spayd(resp.iban, totalServer, msg, vs);
      renderQR(payloadSpayd);
      priceEl.textContent = `Cena: ${kc(totalServer)} Kč  •  Délka lekce: ${dur} min`;
      discHint.textContent = '';
    } else {
      showCash();
      priceEl.textContent = `Cena: ${kc(totalServer)} Kč (platba na místě)  •  Délka lekce: ${Number(resp?.event?.duration || selected?.duration || 90)} min`;
      discHint.textContent = '';
    }
    await loadEvents();
    const again = EVENTS.find(e=>e.id===resp.event.id);
    if(again){ selected={...again, duration:Number(again.duration||90)}; refreshPricePreview(); }
  }catch(e){
    errBox.textContent='Něco se pokazilo při odeslání. Zkuste to prosím znovu.';
  }finally{
    btn.disabled=false;
    window.__postIframeHeight && window.__postIframeHeight();
  }
});
loadEvents();
</script>
<!-- [KROK 3] Povinná textová zmínka reCAPTCHA (badge je skrytý) -->
<div style="text-align:center;font-size:11px;color:#9ca3af;padding:12px 16px 8px;">
  Tento web je chráněn reCAPTCHA od Google.
  <a href="https://policies.google.com/privacy" style="color:#9ca3af;" target="_blank">Zásady ochrany</a> &amp;
  <a href="https://policies.google.com/terms" style="color:#9ca3af;" target="_blank">Smluvní podmínky</a>.
</div>
</body>
</html>
